# Dynmap Configuração
## Instalando e configurando o NGINX
Primeiro instale o NGINX:
```bash
sudo apt install nginx
```

Se tudo correu tudo bem durante a instação, vamos agora executar alguns comandos que mostra na wiki do dynmap:

__Para mais informações consulte a [wiki do dynmap](https://github.com/webbukkit/dynmap/wiki/%5BTutorial%5D-Setting-up-a-standalone-web-server-with-MySQL-SQLite/#general-setup-with-the-nginx-web-server)__

1. `sudo cp /etc/nginx/sites-available/default /etc/nginx/sites-available/dynmap`

2. `sudo rm /etc/nginx/sites-enabled/default`

3. `sudo service nginx restart`

Agora vamos precisar alterar o arquivo de configuração do NGINX conforme mostra a wiki do dynmap.
Primeiro vamos abrir o arquivo:
```bash
sudo vi /etc/nginx/sites-available/dynmap
```

Depois vamos deixar o arquivo de config conforme o exemplo a seguir:
```shell
server server {
	listen 20054 default_server;
	listen [::]:20054 default_server;

	# SSL configuration
	#
	# listen 443 ssl default_server;
	# listen [::]:443 ssl default_server;
	#
	# Note: You should disable gzip for SSL traffic.
	# See: https://bugs.debian.org/773332
	#
	# Read up on ssl_ciphers to ensure a secure configuration.
	# See: https://bugs.debian.org/765782
	#
	# Self signed certs generated by the ssl-cert package
	# Don't use them in a production server!
	#
	# include snippets/snakeoil.conf;

	root /home/canary/dynmap;


	# Add index.php to the list if you are using PHP
	index index.php index.html index.htm;

	server_name map.grngroup.net;

	location / {
		# First attempt to serve request as file, then
		# as directory, then fall back to displaying a 404.
		try_files $uri $uri/ =404;
	}

	# pass PHP scripts to FastCGI server
	#
	location ~ \.php$ {
		include snippets/fastcgi-php.conf;
	
		# With php-fpm (or other unix sockets):
		fastcgi_pass unix:/run/php/php7.4-fpm.sock;
	#	# With php-cgi (or other tcp sockets):
	#	fastcgi_pass 127.0.0.1:9000;
	}

	# deny access to .htaccess files, if Apache's document root
	# concurs with nginx's one
	#
	location ~ /\.ht {
		deny all;
	}
}
```

Depois execute este comando:
```bash
ln -s /etc/nginx/sites-available/dynmap /etc/nginx/sites-enabled/dynmap

```

Depois este, e verifique se consta algum erro:
```bash
sudo nginx -t 
```

Lembre-se de alterar o caminho do web do dynmap `root /home/someuser/minecraft/servers/creative/plugins/dynmap/web;` para caminho aonda está salvo seu dynmap/web. E também alterar o dominio `map.seudominio.com` para o seu.

/home/canary/dynmap

Agora reinicie o NGINX:
```bash
sudo service nginx restart
```

Tente acessar o ip e porta escolhida no seu navegador:
`http://192.168.0.100`
Possivelmente, ainda não funcionou.

Vamos agora para possiveis solução.

Consulte o log de erro primeiramente:
```bash
sudo cat /var/log/nginx/error.log
```

### Erro de permissão
Execute este comando, alterando o `path` pelo caminho da pasta onde está o web do dynmap.
Para saber o `path` da pasta, acesse a pasta e digite:
```bash
pwd
```
Vai retornar o caminho, substiua no comando abaixo:

```bash
sudo chown -R :www-data path
```


### Erro com [PHP FPM](https://www.php.net/manual/pt_BR/install.fpm.php)
Não sei exatamente o que é isto, porém é necessário para rodar o dynmap web.
Verifique se existe o mesmo instalado no seu servidor, caso não tenha instale usando este comando:
```
sudo apt-get install php7.4-fpm
```

**Lembres de alterar a versão 7.4 para versão que aparece no seu log de erro**

### Erro com [MySql](https://www.php.net/manual/pt_BR/book.mysqli.php)
Este erro pelas minhas pesquisa é pela falta do programa que faz a conexão com banco MySql e o PHP, para isso execute o comando a seguir:
```bash
sudo apt-get install php7.4-mysqli
```

**Lembres de alterar a versão 7.4 para versão que aparece no seu log de erro**

### Erro com PORTA de conexão [UFW Firewall]()
Normalmente é devido que NGINX está funcionando na porta 443 ou 80, que é padrão, para funcionar basta habilitar a porta desejada:

```bash
sudo ufw allow 20054/tcp
```

Caso o `ufw` não esteja habilitado no seu servidor para verificar execute:
```bash
sudo ufw status
```

Caso o retorno for inative pode ativar o mesmo utilizando:
```bash
sudo ufw sites-enabled
```

**ATENÇÃO: Pode ser sua conexão SSH cai, pois é necessário habilitar a mesma novamente com o comando abaixo e também habilitar demais outras portas que estava utilizando no servidor.**

**Lembre-se de desativar as portas padrão do NGINX**
Liste todos as portas do `ufw`:
```bash
sudo ufw status numbered
```

Depois de localizazr as portas com comentário `Nginx` e desativar a mesma:

```bash
sudo ufw delete id
```

Altera o `id` do comando acima pela porta do Nginx aberta, rode primeiramente para HTTP e depois para HTTPS, e depois verifique se as portas foram fechadas.
```bash
sudo ufw status
```